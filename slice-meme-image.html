<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表情包切片工具</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap');

        body {
            background-color: #f8fafc; /* 这里的背景色更接近参考图的冷灰/白 */
            color: #334155;
            font-family: "Inter", "Noto Sans SC", sans-serif;
        }

        /* 虚线上传区域动画 */
        .upload-zone {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='8%2c 8' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.2s ease;
        }
        .upload-zone:hover, .upload-zone.drag-active {
            background-color: #eff6ff; /* blue-50 */
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%233B82F6FF' stroke-width='2' stroke-dasharray='8%2c 8' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }

        /* 隐藏文件输入框 */
        input[type="file"] {
            display: none;
        }

        /* 预览区域背景纹理 */
        .preview-pattern {
            background-image: 
                linear-gradient(45deg, #f1f5f9 25%, transparent 25%), 
                linear-gradient(-45deg, #f1f5f9 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #f1f5f9 75%), 
                linear-gradient(-45deg, transparent 75%, #f1f5f9 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body class="min-h-screen py-10 px-4 md:px-8 flex flex-col items-center relative">

    <!-- Buy Me A Coffee Button -->
    <a href="https://buymeacoffee.com/lizhaoshui" target="_blank" rel="noopener noreferrer" 
       class="absolute top-4 right-4 md:top-6 md:right-8 bg-[#FFDD00] text-slate-800 p-2.5 rounded-full shadow-sm hover:shadow-md transition-all hover:-translate-y-0.5 active:scale-95 group" 
       title="Buy me a coffee">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-slate-900">
            <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
            <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
            <line x1="6" y1="1" x2="6" y2="4"></line>
            <line x1="10" y1="1" x2="10" y2="4"></line>
            <line x1="14" y1="1" x2="14" y2="4"></line>
        </svg>
    </a>

    <!-- Header -->
    <header class="text-center mb-10">
        <div class="flex items-center justify-center gap-2 mb-2">
            <!-- 剪刀图标 -->
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/>
                <line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/>
                <line x1="8.12" y1="8.12" x2="12" y2="12"/>
            </svg>
            <h1 class="text-3xl font-bold text-slate-800 tracking-tight">表情包切片工具</h1>
        </div>
        <p class="text-slate-500">上传 6x4 (或自定义) 的表情包合集，自动裁剪并打包下载</p>
    </header>

    <!-- Main Layout -->
    <div class="max-w-6xl w-full grid grid-cols-1 lg:grid-cols-12 gap-8 items-stretch">
        
        <!-- Left Column: Controls (Approx 1/3 width) -->
        <div class="lg:col-span-4 space-y-6 flex flex-col">
            <!-- Added h-full to make it stretch to match right column height -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 h-full flex flex-col">
                
                <!-- 1. Upload -->
                <div class="mb-8">
                    <h2 class="text-sm font-bold text-slate-800 mb-3 flex items-center">
                        <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs mr-2">1</span>
                        上传图片
                    </h2>
                    <label id="dropZone" class="upload-zone w-full h-40 flex flex-col items-center justify-center cursor-pointer rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        <span class="text-sm text-slate-500 font-medium">点击或拖拽上传图片</span>
                        <input type="file" id="fileInput" accept="image/*" />
                    </label>
                </div>

                <!-- 2. Settings -->
                <div class="mb-8 flex-grow">
                    <h2 class="text-sm font-bold text-slate-800 mb-3 flex items-center">
                        <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs mr-2">2</span>
                        网格设置
                    </h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1.5">列数 (宽)</label>
                            <input type="number" id="colInput" value="6" min="1" 
                                class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-medium">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1.5">行数 (高)</label>
                            <input type="number" id="rowInput" value="4" min="1" 
                                class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-medium">
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="block text-xs font-medium text-slate-500 mb-1.5">文件名前缀</label>
                        <input type="text" id="prefixInput" value="sticker" placeholder="例如: emoji"
                            class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm">
                    </div>
                </div>

                <!-- Action Button -->
                <button id="processBtn" disabled class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-3.5 px-4 rounded-xl shadow-md shadow-blue-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none transition-all flex items-center justify-center gap-2 mt-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <span id="btnText">裁剪并下载 ZIP</span>
                </button>

            </div>

            <!-- Success Message (Hidden by default) -->
            <div id="successMsg" class="hidden bg-emerald-50 border border-emerald-100 rounded-xl p-4 flex items-start gap-3">
                <div class="bg-emerald-100 p-1 rounded-full text-emerald-600 mt-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-emerald-800">成功!</h4>
                    <p class="text-xs text-emerald-600 mt-0.5" id="successText">已打包 24 张表情包。</p>
                </div>
            </div>
        </div>

        <!-- Right Column: Preview (Approx 2/3 width) -->
        <div class="lg:col-span-8 flex flex-col">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-full min-h-[500px]">
                
                <!-- Preview Header -->
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center">
                        <span class="text-slate-400 font-normal mr-2">3.</span>
                        预览确认
                    </h2>
                    <span class="bg-slate-100 text-slate-500 text-xs font-semibold px-2.5 py-1 rounded-md">
                        预期切片数量: <span id="sliceCount">24</span>
                    </span>
                </div>

                <!-- Canvas Area -->
                <div class="flex-1 p-6 bg-slate-50 flex items-center justify-center overflow-hidden relative">
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="text-center">
                        <div class="w-20 h-20 bg-slate-200 rounded-full mx-auto mb-4 flex items-center justify-center text-slate-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                        </div>
                        <p class="text-slate-400 text-sm">请先在左侧上传图片</p>
                    </div>

                    <!-- Image Container -->
                    <div id="previewContainer" class="hidden shadow-lg rounded-lg overflow-hidden relative" style="max-width: 100%; max-height: 600px;">
                        <img id="sourceImage" src="" alt="Source" class="block max-w-full h-auto" style="max-height: 600px;">
                        <canvas id="gridOverlay" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
                    </div>
                </div>

                <!-- Footer Tip -->
                <div class="px-6 py-4 bg-white border-t border-slate-100 text-center">
                    <p class="text-xs text-slate-400">
                        提示: 红线为裁剪分割线。如果红线没有对齐图片缝隙，请调整行/列数或裁剪原图边缘。
                    </p>
                </div>

            </div>
        </div>

    </div>

    <div class="mt-12 text-slate-400 text-xs text-center">
        本地安全处理，图片不会上传至服务器
    </div>

    <!-- Hidden canvas for processing -->
    <canvas id="processCanvas" class="hidden"></canvas>

    <script>
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const colInput = document.getElementById('colInput');
        const rowInput = document.getElementById('rowInput');
        const prefixInput = document.getElementById('prefixInput');
        const processBtn = document.getElementById('processBtn');
        const btnText = document.getElementById('btnText');
        
        const previewContainer = document.getElementById('previewContainer');
        const emptyState = document.getElementById('emptyState');
        const sourceImage = document.getElementById('sourceImage');
        const gridOverlay = document.getElementById('gridOverlay');
        const sliceCountDisplay = document.getElementById('sliceCount');
        
        const successMsg = document.getElementById('successMsg');
        const successText = document.getElementById('successText');

        const processCanvas = document.getElementById('processCanvas');
        const ctx = processCanvas.getContext('2d', { willReadFrequently: true });

        // State
        let currentFile = null;
        let originalImageWidth = 0;
        let originalImageHeight = 0;

        // --- Event Listeners ---

        // File Input
        fileInput.addEventListener('change', handleFileSelect);

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-active');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-active');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect({ target: fileInput });
            }
        });

        // Inputs
        colInput.addEventListener('input', () => { updateGridOverlay(); updateCount(); });
        rowInput.addEventListener('input', () => { updateGridOverlay(); updateCount(); });
        
        // Button
        processBtn.addEventListener('click', processAndZip);
        
        // Window Resize
        window.addEventListener('resize', updateGridOverlay);


        // --- Functions ---

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            currentFile = file;
            const reader = new FileReader();

            reader.onload = function(event) {
                sourceImage.src = event.target.result;
                sourceImage.onload = () => {
                    originalImageWidth = sourceImage.naturalWidth;
                    originalImageHeight = sourceImage.naturalHeight;
                    
                    // Show Preview, Hide Empty State
                    emptyState.classList.add('hidden');
                    previewContainer.classList.remove('hidden');
                    
                    // Enable Button
                    processBtn.disabled = false;
                    
                    // Hide previous success msg
                    successMsg.classList.add('hidden');

                    updateCount();
                    // Wait a tick for render
                    setTimeout(updateGridOverlay, 50);
                };
            };
            reader.readAsDataURL(file);
        }

        function updateCount() {
            const cols = parseInt(colInput.value) || 0;
            const rows = parseInt(rowInput.value) || 0;
            sliceCountDisplay.textContent = cols * rows;
        }

        function updateGridOverlay() {
            if (!sourceImage.src || sourceImage.src === "") return;

            const cols = parseInt(colInput.value) || 6;
            const rows = parseInt(rowInput.value) || 4;

            // Important: Set canvas resolution to match the RENDERED size of the image, 
            // not the natural size, so lines look sharp on screen.
            const rect = sourceImage.getBoundingClientRect();
            gridOverlay.width = rect.width;
            gridOverlay.height = rect.height;

            const oCtx = gridOverlay.getContext('2d');
            oCtx.clearRect(0, 0, gridOverlay.width, gridOverlay.height);

            const cellW = gridOverlay.width / cols;
            const cellH = gridOverlay.height / rows;

            oCtx.strokeStyle = 'rgba(239, 68, 68, 0.8)'; // Red-500
            oCtx.lineWidth = 1;
            oCtx.setLineDash([4, 2]); // Dashed lines for better visibility
            oCtx.beginPath();

            // Draw Verticals
            for (let i = 1; i < cols; i++) {
                const x = i * cellW;
                oCtx.moveTo(x, 0);
                oCtx.lineTo(x, gridOverlay.height);
            }

            // Draw Horizontals
            for (let j = 1; j < rows; j++) {
                const y = j * cellH;
                oCtx.moveTo(0, y);
                oCtx.lineTo(gridOverlay.width, y);
            }

            oCtx.stroke();
            
            // Draw Border (Optional, helpful to see edges)
            oCtx.setLineDash([]);
            oCtx.strokeStyle = 'rgba(239, 68, 68, 0.3)';
            oCtx.strokeRect(0, 0, gridOverlay.width, gridOverlay.height);
        }

        async function processAndZip() {
            if (!currentFile) return;

            const cols = parseInt(colInput.value);
            const rows = parseInt(rowInput.value);
            const prefix = prefixInput.value.trim() || "sticker";
            
            const zip = new JSZip();
            // Folder name same as prefix or default
            const folderName = prefix + "_pack";
            const folder = zip.folder(folderName);

            // UI State
            processBtn.disabled = true;
            const originalBtnText = btnText.textContent;
            btnText.textContent = "处理中...";
            successMsg.classList.add('hidden');

            // Set canvas to FULL original resolution
            processCanvas.width = originalImageWidth;
            processCanvas.height = originalImageHeight;
            ctx.drawImage(sourceImage, 0, 0);

            const cellW = originalImageWidth / cols;
            const cellH = originalImageHeight / rows;

            let count = 0;
            const promises = [];

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    count++;
                    // 修复：在同步循环中提前生成文件名，避免异步回调中 count 变量取值错误
                    const fileName = `${prefix}_${String(count).padStart(2, '0')}.png`;

                    const p = new Promise((resolve) => {
                        const cellCanvas = document.createElement('canvas');
                        cellCanvas.width = cellW;
                        cellCanvas.height = cellH;
                        const cellCtx = cellCanvas.getContext('2d');

                        cellCtx.drawImage(
                            sourceImage, 
                            c * cellW, r * cellH, cellW, cellH, 
                            0, 0, cellW, cellH
                        );

                        cellCanvas.toBlob((blob) => {
                            // 这里直接使用闭包捕获的 fileName 常量
                            folder.file(fileName, blob);
                            resolve();
                        }, 'image/png');
                    });
                    promises.push(p);
                }
            }

            await Promise.all(promises);

            btnText.textContent = "正在压缩...";

            zip.generateAsync({type:"blob"}).then(function(content) {
                const link = document.createElement("a");
                link.href = URL.createObjectURL(content);
                link.download = `${folderName}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Reset UI
                processBtn.disabled = false;
                btnText.textContent = originalBtnText;
                
                // Show Success
                successText.textContent = `已成功打包 ${count} 张表情包 (前缀: ${prefix})`;
                successMsg.classList.remove('hidden');
            });
        }
        
        // 初始化时调用一次，确保默认数字（或浏览器缓存的输入数字）显示正确
        updateCount();
    </script>
</body>
</html>